/**
 * @fileoverview Firestore Security Rules for the dropshipping store application.
 *
 * Core Philosophy:
 * This ruleset enforces a strict user-ownership model for sites and their associated configurations (themes, headers, footers, etc.).
 *  Sites are owned by the user who created them. Sub-resources inherit the site owner's ID.
 *  Global admin roles are supported via a separate `roles_admin` collection.
 *
 * Data Structure:
 * - /sites/{siteId}: Represents a dropshipping store configuration, owned by a user.
 * - /sites/{siteId}/themes/{themeId}: Themes associated with a site.
 * - /sites/{siteId}/themes/{themeId}/headers/{headerId}: Headers for a theme.
 * - /sites/{siteId}/themes/{themeId}/footers/{footerId}: Footers for a theme.
 * - /sites/{siteId}/themes/{themeId}/footers/{footerId}/newsletters/{newsletterId}: Newsletters for a footer.
 * - /sites/{siteId}/categories/{categoryId}: Product categories for a site.
 * - /sites/{siteId}/categories/{categoryId}/filters/{filterId}: Filters for a category.
 * - /sites/{siteId}/categories/{categoryId}/filters/{filterId}/priceRanges/{priceRangeId}: Price ranges for a filter.
 * - /sites/{siteId}/products/{productId}: Products for a site.
 * - /sites/{siteId}/labels/{labelId}: Labels for a site.
 * - /sites/{siteId}/dropshipping/{dropshippingId}: Dropshipping configurations for a site.
 * - /sites/{siteId}/dropshipping/{dropshippingId}/supplierIntegrations/{supplierIntegrationId}: Supplier integrations for dropshipping.
 * - /sites/{siteId}/dropshipping/{dropshippingId}/shippings/{shippingId}: Shipping configurations for dropshipping.
 * - /sites/{siteId}/dropshipping/{dropshippingId}/inventories/{inventoryId}: Inventory configurations for dropshipping.
 * - /sites/{siteId}/uiBehaviours/{uiBehaviourId}: UI behavior configurations for a site.
 * - /sites/{siteId}/uiBehaviours/{uiBehaviourId}/paginations/{paginationId}: Pagination configurations for UI behavior.
 * - /sites/{siteId}/seos/{seoId}: SEO configurations for a site.
 * - /roles_admin/{userId}: Indicates global admin status for a user.
 *
 * Key Security Decisions:
 * - Strict ownership is enforced for all `site` subcollections, based on the `ownerId` denormalized field.
 * - User listing is disallowed.
 * - Data schema is not strictly enforced (prototyping mode).
 *
 * Denormalization for Authorization:
 * - To avoid costly `get()` calls, the `ownerId` of a `site` is denormalized into all subcollections.
 *   This allows subcollection rules to efficiently check site ownership without extra reads.
 *
 * Structural Segregation:
 * - Admin roles are stored in the separate `/roles_admin` collection.
 */
rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    /**
     * @description Checks if the request is authenticated.
     * @principle Authentication is required for most operations.
     */
    function isSignedIn() {
      return request.auth != null;
    }

    /**
     * @description Checks if the authenticated user's ID matches the provided userId.
     * @param {string} userId The user ID to compare against.
     * @principle Enforces user-specific data access.
     */
    function isOwner(userId) {
      return isSignedIn() && request.auth.uid == userId;
    }

    /**
     * @description Checks if the authenticated user is an existing owner of the document.
     * @param {string} userId The user ID to compare against.
     * @principle Enforces user-specific data access and verifies document existence.
     */
    function isExistingOwner(userId) {
      return isOwner(userId) && resource != null;
    }

        /**
     * @description Checks if the user has admin role by checking roles_admin collection
     * @principle Secures admin routes
     */
    function isAdmin() {
            return exists(/databases/$(database)/documents/roles_admin/$(request.auth.uid));
    }

    /**
     * @description Rules for the /sites collection.
     * @path /sites/{siteId}
     * @allow (create) - Authenticated user can create a site if the site.id matches their UID.
     * @allow (get, list, update, delete) - Only the site owner can read, update, or delete the site.
     * @deny (create) - An unauthenticated user cannot create a site.
     * @deny (update, delete) - Another user (not the owner) cannot update or delete the site.
     * @principle Enforces document ownership for writes.
     */
    match /sites/{siteId} {
      allow get: if true;
      allow list: if isAdmin();
      allow create: if isSignedIn() && request.auth.uid == siteId;
      allow update: if isExistingOwner(siteId);
      allow delete: if isExistingOwner(siteId);
    }

    /**
     * @description Rules for the /sites/{siteId}/themes collection.
     * @path /sites/{siteId}/themes/{themeId}
     * @allow (create) - Only the site owner can create a theme.
     * @allow (get, list, update, delete) - Only the site owner can read, update, or delete themes.
     * @deny (create) - An unauthenticated user cannot create a theme.
     * @deny (update, delete) - Another user (not the owner) cannot update or delete themes.
     * @principle Enforces document ownership for writes.
     */
    match /sites/{siteId}/themes/{themeId} {
      allow get: if true;
      allow list: if isAdmin();
      allow create: if isExistingOwner(siteId);
      allow update: if isExistingOwner(siteId);
      allow delete: if isExistingOwner(siteId);
    }

    /**
     * @description Rules for the /sites/{siteId}/themes/{themeId}/headers collection.
     * @path /sites/{siteId}/themes/{themeId}/headers/{headerId}
     * @allow (create) - Only the site owner can create a header.
     * @allow (get, list, update, delete) - Only the site owner can read, update, or delete headers.
     * @deny (create) - An unauthenticated user cannot create a header.
     * @deny (update, delete) - Another user (not the owner) cannot update or delete headers.
     * @principle Enforces document ownership for writes.
     */
    match /sites/{siteId}/themes/{themeId}/headers/{headerId} {
      allow get: if true;
      allow list: if isAdmin();
      allow create: if isExistingOwner(siteId);
      allow update: if isExistingOwner(siteId);
      allow delete: if isExistingOwner(siteId);
    }

    /**
     * @description Rules for the /sites/{siteId}/themes/{themeId}/footers collection.
     * @path /sites/{siteId}/themes/{themeId}/footers/{footerId}
     * @allow (create) - Only the site owner can create a footer.
     * @allow (get, list, update, delete) - Only the site owner can read, update, or delete footers.
     * @deny (create) - An unauthenticated user cannot create a footer.
     * @deny (update, delete) - Another user (not the owner) cannot update or delete footers.
     * @principle Enforces document ownership for writes.
     */
    match /sites/{siteId}/themes/{themeId}/footers/{footerId} {
      allow get: if true;
      allow list: if isAdmin();
      allow create: if isExistingOwner(siteId);
      allow update: if isExistingOwner(siteId);
      allow delete: if isExistingOwner(siteId);
    }

    /**
     * @description Rules for the /sites/{siteId}/themes/{themeId}/footers/{footerId}/newsletters collection.
     * @path /sites/{siteId}/themes/{themeId}/footers/{footerId}/newsletters/{newsletterId}
     * @allow (create) - Only the site owner can create a newsletter.
     * @allow (get, list, update, delete) - Only the site owner can read, update, or delete newsletters.
     * @deny (create) - An unauthenticated user cannot create a newsletter.
     * @deny (update, delete) - Another user (not the owner) cannot update or delete newsletters.
     * @principle Enforces document ownership for writes.
     */
    match /sites/{siteId}/themes/{themeId}/footers/{footerId}/newsletters/{newsletterId} {
      allow get: if true;
      allow list: if isAdmin();
      allow create: if isExistingOwner(siteId);
      allow update: if isExistingOwner(siteId);
      allow delete: if isExistingOwner(siteId);
    }

    /**
     * @description Rules for the /sites/{siteId}/categories collection.
     * @path /sites/{siteId}/categories/{categoryId}
     * @allow (create) - Only the site owner can create a category.
     * @allow (get, list, update, delete) - Only the site owner can read, update, or delete categories.
     * @deny (create) - An unauthenticated user cannot create a category.
     * @deny (update, delete) - Another user (not the owner) cannot update or delete categories.
     * @principle Enforces document ownership for writes.
     */
    match /sites/{siteId}/categories/{categoryId} {
      allow get: if true;
      allow list: if isAdmin();
      allow create: if isExistingOwner(siteId);
      allow update: if isExistingOwner(siteId);
      allow delete: if isExistingOwner(siteId);
    }

    /**
     * @description Rules for the /sites/{siteId}/categories/{categoryId}/filters collection.
     * @path /sites/{siteId}/categories/{categoryId}/filters/{filterId}
     * @allow (create) - Only the site owner can create a filter.
     * @allow (get, list, update, delete) - Only the site owner can read, update, or delete filters.
     * @deny (create) - An unauthenticated user cannot create a filter.
     * @deny (update, delete) - Another user (not the owner) cannot update or delete filters.
     * @principle Enforces document ownership for writes.
     */
    match /sites/{siteId}/categories/{categoryId}/filters/{filterId} {
      allow get: if true;
      allow list: if isAdmin();
      allow create: if isExistingOwner(siteId);
      allow update: if isExistingOwner(siteId);
      allow delete: if isExistingOwner(siteId);
    }

    /**
     * @description Rules for the /sites/{siteId}/categories/{categoryId}/filters/{filterId}/priceRanges collection.
     * @path /sites/{siteId}/categories/{categoryId}/filters/{filterId}/priceRanges/{priceRangeId}
     * @allow (create) - Only the site owner can create a priceRange.
     * @allow (get, list, update, delete) - Only the site owner can read, update, or delete priceRanges.
     * @deny (create) - An unauthenticated user cannot create a priceRange.
     * @deny (update, delete) - Another user (not the owner) cannot update or delete priceRanges.
     * @principle Enforces document ownership for writes.
     */
    match /sites/{siteId}/categories/{categoryId}/filters/{filterId}/priceRanges/{priceRangeId} {
      allow get: if true;
      allow list: if isAdmin();
      allow create: if isExistingOwner(siteId);
      allow update: if isExistingOwner(siteId);
      allow delete: if isExistingOwner(siteId);
    }

    /**
     * @description Rules for the /sites/{siteId}/products collection.
     * @path /sites/{siteId}/products/{productId}
     * @allow (create) - Only the site owner can create a product.
     * @allow (get, list, update, delete) - Only the site owner can read, update, or delete products.
     * @deny (create) - An unauthenticated user cannot create a product.
     * @deny (update, delete) - Another user (not the owner) cannot update or delete products.
     * @principle Enforces document ownership for writes.
     */
    match /sites/{siteId}/products/{productId} {
      allow get: if true;
      allow list: if isAdmin();
      allow create: if isExistingOwner(siteId);
      allow update: if isExistingOwner(siteId);
      allow delete: if isExistingOwner(siteId);
    }

    /**
     * @description Rules for the /sites/{siteId}/labels collection.
     * @path /sites/{siteId}/labels/{labelId}
     * @allow (create) - Only the site owner can create a label.
     * @allow (get, list, update, delete) - Only the site owner can read, update, or delete labels.
     * @deny (create) - An unauthenticated user cannot create a label.
     * @deny (update, delete) - Another user (not the owner) cannot update or delete labels.
     * @principle Enforces document ownership for writes.
     */
    match /sites/{siteId}/labels/{labelId} {
      allow get: if true;
      allow list: if isAdmin();
      allow create: if isExistingOwner(siteId);
      allow update: if isExistingOwner(siteId);
      allow delete: if isExistingOwner(siteId);
    }

    /**
     * @description Rules for the /sites/{siteId}/dropshipping collection.
     * @path /sites/{siteId}/dropshipping/{dropshippingId}
     * @allow (create) - Only the site owner can create a dropshipping configuration.
     * @allow (get, list, update, delete) - Only the site owner can read, update, or delete dropshipping configurations.
     * @deny (create) - An unauthenticated user cannot create a dropshipping configuration.
     * @deny (update, delete) - Another user (not the owner) cannot update or delete dropshipping configurations.
     * @principle Enforces document ownership for writes.
     */
    match /sites/{siteId}/dropshipping/{dropshippingId} {
      allow get: if true;
      allow list: if isAdmin();
      allow create: if isExistingOwner(siteId);
      allow update: if isExistingOwner(siteId);
      allow delete: if isExistingOwner(siteId);
    }

    /**
     * @description Rules for the /sites/{siteId}/dropshipping/{dropshippingId}/supplierIntegrations collection.
     * @path /sites/{siteId}/dropshipping/{dropshippingId}/supplierIntegrations/{supplierIntegrationId}
     * @allow (create) - Only the site owner can create a supplierIntegration.
     * @allow (get, list, update, delete) - Only the site owner can read, update, or delete supplierIntegrations.
     * @deny (create) - An unauthenticated user cannot create a supplierIntegration.
     * @deny (update, delete) - Another user (not the owner) cannot update or delete supplierIntegrations.
     * @principle Enforces document ownership for writes.
     */
    match /sites/{siteId}/dropshipping/{dropshippingId}/supplierIntegrations/{supplierIntegrationId} {
      allow get: if true;
      allow list: if isAdmin();
      allow create: if isExistingOwner(siteId);
      allow update: if isExistingOwner(siteId);
      allow delete: if isExistingOwner(siteId);
    }

    /**
     * @description Rules for the /sites/{siteId}/dropshipping/{dropshippingId}/shippings collection.
     * @path /sites/{siteId}/dropshipping/{dropshippingId}/shippings/{shippingId}
     * @allow (create) - Only the site owner can create a shipping.
     * @allow (get, list, update, delete) - Only the site owner can read, update, or delete shippings.
     * @deny (create) - An unauthenticated user cannot create a shipping.
     * @deny (update, delete) - Another user (not the owner) cannot update or delete shippings.
     * @principle Enforces document ownership for writes.
     */
    match /sites/{siteId}/dropshipping/{dropshippingId}/shippings/{shippingId} {
      allow get: if true;
      allow list: if isAdmin();
      allow create: if isExistingOwner(siteId);
      allow update: if isExistingOwner(siteId);
      allow delete: if isExistingOwner(siteId);
    }

    /**
     * @description Rules for the /sites/{siteId}/dropshipping/{dropshippingId}/inventories collection.
     * @path /sites/{siteId}/dropshipping/{dropshippingId}/inventories/{inventoryId}
     * @allow (create) - Only the site owner can create an inventory.
     * @allow (get, list, update, delete) - Only the site owner can read, update, or delete inventories.
     * @deny (create) - An unauthenticated user cannot create an inventory.
     * @deny (update, delete) - Another user (not the owner) cannot update or delete inventories.
     * @principle Enforces document ownership for writes.
     */
    match /sites/{siteId}/dropshipping/{dropshippingId}/inventories/{inventoryId} {
      allow get: if true;
      allow list: if isAdmin();
      allow create: if isExistingOwner(siteId);
      allow update: if isExistingOwner(siteId);
      allow delete: if isExistingOwner(siteId);
    }

    /**
     * @description Rules for the /sites/{siteId}/uiBehaviours collection.
     * @path /sites/{siteId}/uiBehaviours/{uiBehaviourId}
     * @allow (create) - Only the site owner can create a uiBehaviour.
     * @allow (get, list, update, delete) - Only the site owner can read, update, or delete uiBehaviours.
     * @deny (create) - An unauthenticated user cannot create a uiBehaviour.
     * @deny (update, delete) - Another user (not the owner) cannot update or delete uiBehaviours.
     * @principle Enforces document ownership for writes.
     */
    match /sites/{siteId}/uiBehaviours/{uiBehaviourId} {
      allow get: if true;
      allow list: if isAdmin();
      allow create: if isExistingOwner(siteId);
      allow update: if isExistingOwner(siteId);
      allow delete: if isExistingOwner(siteId);
    }

    /**
     * @description Rules for the /sites/{siteId}/uiBehaviours/{uiBehaviourId}/paginations collection.
     * @path /sites/{siteId}/uiBehaviours/{uiBehaviourId}/paginations/{paginationId}
     * @allow (create) - Only the site owner can create a pagination.
     * @allow (get, list, update, delete) - Only the site owner can read, update, or delete paginations.
     * @deny (create) - An unauthenticated user cannot create a pagination.
     * @deny (update, delete) - Another user (not the owner) cannot update or delete paginations.
     * @principle Enforces document ownership for writes.
     */
    match /sites/{siteId}/uiBehaviours/{uiBehaviourId}/paginations/{paginationId} {
      allow get: if true;
      allow list: if isAdmin();
      allow create: if isExistingOwner(siteId);
      allow update: if isExistingOwner(siteId);
      allow delete: if isExistingOwner(siteId);
    }

    /**
     * @description Rules for the /sites/{siteId}/seos collection.
     * @path /sites/{siteId}/seos/{seoId}
     * @allow (create) - Only the site owner can create a seo.
     * @allow (get, list, update, delete) - Only the site owner can read, update, or delete seos.
     * @deny (create) - An unauthenticated user cannot create a seo.
     * @deny (update, delete) - Another user (not the owner) cannot update or delete seos.
     * @principle Enforces document ownership for writes.
     */
    match /sites/{siteId}/seos/{seoId} {
      allow get: if true;
      allow list: if isAdmin();
      allow create: if isExistingOwner(siteId);
      allow update: if isExistingOwner(siteId);
      allow delete: if isExistingOwner(siteId);
    }

    /**
     * @description Rules for the /roles_admin collection.
     * @path /roles_admin/{userId}
     * @allow (create) - Only an admin can create an admin role doc.
     * @allow (get, list, update, delete) - Only an admin can read, update, or delete admin role docs.
     * @deny (create) - An unauthenticated user cannot create a admin role.
     * @deny (update, delete) - Another user (not the owner) cannot update or delete admin roles.
     */
        match /roles_admin/{userId} {
            allow get: if isAdmin();
            allow list: if false;
            allow create: if isAdmin();
            allow update: if false;
            allow delete: if isAdmin();
        }
  }
}